---
title: "Group Project 2"
subtitle: <center> Intro and EDA </center>
author: <center> Joshua Carpenter, Yong-Nan Chan, Andy Phillips, and Brandon Fletcher <center>
output: html_document
---

<style type="text/css">
h1.title {
font-size: 40px;
text-align: center;
}
h4.author 
font-size: 40px;
text-align: center;
}
</style>

```{r setup, include=FALSE}
# load packages here
library(corrplot)
library(tidyverse)
library(ggfortify)
library(car)
library(bestglm)
library(glmnet)
set.seed(89954)
```

### Background and Introduction

The World Health Organization (WHO) and United Nations (UN) were interested in factors affecting life expectancy in countries around the world. In 2015 they collected demographic and immunization data from 130 countries.\

The purpose of this analysis is to find which factors are correlated with life expectancy and their relationship. We expect to find that having a greater proportion of the population immunized will lead to increased life expectancy and that greater schooling will also be associated with greater life expectancy, although especially in that case we do not believe there is necessarily a causal relationship.\

To analyze these hypotheses, we will perform linear regression using `life.expectancy` as our response variable. We will check the assumptions of linear regression and remove or transform variables as necessary. If transformations are necessary, we will use the Box-Cox method and plots of different transformations to help us determine the best one. In order to avoid multicolinearity and over-fitting, we will use several variable selection and shrinkage methods to choose the most appropriate subset of variables to keep in the model. After performing regression, we will examine the model and the hypothesis tests to see which variables are significant and how they affect life expectancy. Finally, we will provide our results along with confidence intervals.

### Methods and Results

The data set we will be using contains measurements, collected in 2015, of 130 different countries. This was collected by the World Health Organization and the United Nations. The data set contains measurements for both developed and developing countries.

The following table displays the variable names in this data set, along with their descriptions.

Variable       | Description
-------------- | -------------
Status         | Country Status (Developed or Developing)
Life.expectancy| Average life expectancy in years
Adult.Mortality| Probability of dying between 15 and 60 years per 1000 population
Hepatitis.B    | Immunization coverage among 1-year-olds (%)
Measles        | Number of reported cases er 1000 population
BMI            | Average Body Mass Index of entire population
Polio          | Immunization coverage among 1-year-olds (%)
Diphtheria     | Immunization coverage among 1-year-olds (%)
GDP            | Gross Domestic Product per Capita (In USD)
Population     | Population of the country
Schooling      | Average number of years of schooling


We start by applying basic summary and exploratory statistics to this data to better understand the data and identify trends.

```{r, message=FALSE}
life_expect <- read_csv("lifeexpect.csv") %>%
  # Change Status into a numeric variable where 1 means
  #   developed and 0 means developing
  mutate(Status = factor(Status),
         # Fix capitalization on Life.expectancy
         Life.Expectancy = Life.expectancy) %>%
  # Remove un-needed columns
  select(Life.Expectancy, Adult.Mortality, Hepatitis.B, BMI, Polio,
         Diphtheria, GDP, Population, Schooling, Status) %>% 
  filter(Diphtheria < 100)
life_expect
summary(life_expect)
```
```{r, fig.width=8, fig.height=8}
# create data set only with continuous variable
life_expect_cont <- life_expect %>% select(-Status)

# Function to create scatterplot matrix of `data`
point_matrix <- function(data) {
  par(pty = "s", las = 1)
  pairs(data, pch = ".", lower.panel = NULL)
}
### scatterplot matrix (only with continuous)
point_matrix(life_expect_cont)
```
```{r, results=FALSE, message=FALSE}
### correlation matrix (only used for continuous variables)
round(cor(life_expect_cont), 2)
corrplot(cor(life_expect_cont), type = "upper", diag = F,
         tl.col = "#1f3366", cl.pos = "n")
#### Histogram
histLifeExpect <- function(variable, name, width) {
  ggplot(data = life_expect, mapping = aes(x = variable)) +
  geom_histogram(mapping = aes(y = ..density..), binwidth = width) +
  xlab(name) +
  ylab("Density") +
  theme(aspect.ratio = 1)
}
# We remove GDP because the hist is useless and takes a long time to run
to_hist <- life_expect_cont %>%
  select(-c(Life.Expectancy, GDP))
mapply(histLifeExpect,
       variable = to_hist,
       name = names(to_hist),
       width = c(25, 5, 5, 10, 7, 10000000, 2),
       SIMPLIFY = FALSE)

# Individual scatterplots for easier viewing
scatter <- function(data, x_ind, y_ind) {
  x <- pull(data, x_ind)
  y <- pull(data, y_ind)
  ggplot(mapping = aes(x = x, y = y)) +
    geom_point() +
    geom_smooth(method = "lm", se = FALSE) +
    theme_minimal() +
    theme(aspect.ratio = 1) +
    xlab(names(data)[x_ind]) +
    ylab(names(data)[y_ind])
}
map(2:length(life_expect_cont), scatter, data = life_expect_cont, y_ind = 1)


### Box Plot (for categorical: Status)
ggplot(data = life_expect, mapping = aes(x = Status, y = Life.Expectancy)) +
  geom_boxplot() +
  theme_bw() +
  theme(aspect.ratio = 1)
```
### Variable Selection

```{r, fig.align='center'}
#create new variable and put Life.Expectancy last
life_expect_var <- as.data.frame(life_expect[c("Adult.Mortality", "Hepatitis.B", "BMI", "Polio", "Diphtheria", "GDP", "Population", "Schooling", "Status", "Life.Expectancy")])
summary(life_expect_var)
head(life_expect_var)

life_expect_var_lm <- lm(Life.Expectancy ~ ., life_expect_var)
summary(life_expect_var_lm)

#BEST SUBSETS
life_best_subsets_bic <- bestglm(life_expect_var, IC = "BIC", method = "exhaustive")

life_best_subsets_bic$BestModels
summary(life_best_subsets_bic$BestModel)

# BACKWARD
life_backward_bic <- bestglm(life_expect_var, IC = "BIC", method = "backward", t = 100)
summary(life_backward_bic$BestModel)

# SEQUENTIAL
life_seqrep_bic <- bestglm(life_expect_var, IC = "BIC", method = "seqrep", t = 100)
summary(life_seqrep_bic$BestModel)


# Note: had trouble with the data turning into a matrix here
life_expect_var_x <- as.matrix(life_expect_var[,1:7])
life_expect_var_y <- life_expect_var[,8]

#LASSO
life_expect_var_lasso_cv <- cv.glmnet(x = life_expect_var_x,
                              y = life_expect_var_y,
                              type.measure = "mse",
                              alpha = 1)
life_expect_var_lasso_cv$lambda.min
life_expect_var_lasso_cv$lambda.1se

coef(life_expect_var_lasso_cv, s = "lambda.min")
coef(life_expect_var_lasso_cv, s = "lambda.1se")

#ELASTIC NET
life_expect_var_elastic_cv <- cv.glmnet(x = life_expect_var_x,
                              y = life_expect_var_y,
                              type.measure = "mse",
                              alpha = 0.5)
life_expect_var_elastic_cv$lambda.min
life_expect_var_elastic_cv$lambda.1se

coef(life_expect_var_elastic_cv, s = "lambda.min")
coef(life_expect_var_elastic_cv, s = "lambda.1se")

```


Variable            | Best Subset | Backward | Sequential Replacement | LASSO  | Elastic Net
--------------------| ----------- | -------- | ---------------------- | ------ | -----------
  Adult.Mortality   |      X      |     X    |          X             |   X     |      X
  Hepatitis.B       |             |                                       X            X
  BMI               |                                                     X            X
  Polio             |                                                     X            X
  Diphtheria        |      X            X               X                 X            X
  GDP               |                                                     X            X
  Population        |   
  Schooling         |   
  StatusDeveloping  |                                   X


Given the results from all of the variable selection procedures, shown in the table above, we choose to keep Adult.Mortality and Diphtheria.

## Initial Linear Model
Next, we will run an initial linear model and take a look at the residuals to see what transformations might need to be done.
```{r}
# Useful functions for later
resid_vs_fitted <- function(model) {
  autoplot(model, which = 1, ncol = 1) +
    theme_minimal() +
    theme(aspect.ratio = 1)
}
jcreg_qq <- function(model) {
  autoplot(model, which = 2, ncol = 1) +
    theme_bw() +
    theme(aspect.ratio = 1)
}
jcreg_hist <- function(model) {
  residuals <- data.frame(residuals = resid(model))
  ggplot(data = residuals, mapping = aes(x = residuals)) +
    geom_histogram(binwidth = sd(residuals$residuals / 4),
                   mapping = aes(y = ..density..)) +
    stat_function(fun = dnorm,
                  color = "blue",
                  args = list(mean = 0,
                              sd = sd(residuals$residuals)),
                  size = 1.2) +
    xlab("Residuals") +
    ylab("Density") +
    theme_light()
}
jcreg_av <- function(model) {
  predictors <- attr(model$terms, "term.labels")
  rows <- ifelse(length(predictors > 3),
                 floor(sqrt(length(predictors))),
                 1)
  cols <- ifelse(length(predictors > 3),
                 length(predictors) / rows,
                 3)
  par(pty = "s")
  car::avPlots(model, layout = c(rows, cols), pch = 19)
}
jcreg_BrownForsyth <- function(data, response) {
  grp <- as.factor(c(rep("lower", floor(dim(data)[1] / 2)), 
                     rep("upper", ceiling(dim(data)[1] / 2))))
  leveneTest(pull(stop[order(stop[response]), "resid"]) ~ grp, center = median)
}
```

```{r, warning=FALSE}
init_model <- lm(Life.Expectancy ~ Adult.Mortality + Diphtheria, data = life_expect)
resid_vs_fitted(init_model)
jcreg_hist(init_model)
jcreg_qq(init_model)
shapiro.test(init_model$residuals)

```

The residuals are fairly normal, with some outliers at the lower tail. There does appear to be a slight cone shape to the residuals, which could be a problem. Based on these graphs we will attempt a transformation on the response.

### Transformations
```{r, message=FALSE, fig.height=4}
# Apply boxCox to give us a starting point
boxCox(init_model, lambda = seq(-2, 4, 1/10))

# Squared transformation
life_expect_sq <- life_expect %>%
  mutate(Life.Expectancy = Life.Expectancy^2)
sq_model <- lm(Life.Expectancy ~ Adult.Mortality + Diphtheria, data = life_expect_sq)
resid_vs_fitted(sq_model)
jcreg_hist(sq_model)
jcreg_qq(sq_model)
shapiro.test(sq_model$residuals)

# Power of 1.5 transformation
life_expect_15 <- life_expect %>%
  mutate(Life.Expectancy = Life.Expectancy^1.5)
model_15 <- lm(Life.Expectancy ~ Adult.Mortality + Diphtheria, data = life_expect_15)
resid_vs_fitted(model_15)
jcreg_hist(model_15)
jcreg_qq(model_15)
shapiro.test(model_15$residuals)

# Cubed transformation
life_expect_cu <- life_expect %>%
  mutate(Life.Expectancy = Life.Expectancy^3)
cu_model <- lm(Life.Expectancy ~ Adult.Mortality + Diphtheria, data = life_expect_cu)
resid_vs_fitted(cu_model)
jcreg_hist(cu_model)
jcreg_qq(cu_model)
shapiro.test(cu_model$residuals)

```
Based on the transformations attempted, the best one appears to be a squared or cubic transformation. The cubic transformation sees great improvement in homoscedasticity and some improvement in normality. The squared transformation has somewhat worse homoscedasticity the the cubic, but better normality. For simplicity, we will complete the rest of the analysis on a squared scale. We will attempt to further improve homoscedasticity with transformations of the predictors.

```{r, message=FALSE, results=FALSE}
life_expect_cu_cont <- life_expect_cu %>%
  select(-Status)
jcreg_av(cu_model)
to_hist <- life_expect_cu_cont %>%
  select(-c(Life.Expectancy, GDP))
mapply(histLifeExpect,
       variable = to_hist,
       name = names(to_hist),
       width = c(25, 5, 5, 10, 7, 10000000, 2),
       SIMPLIFY = FALSE)
life_expect_t <- life_expect_cu %>%
  mutate(Adult.Mortality = log(Adult.Mortality),
         Population = log(Population),
         Hepatitis.B = log(1000 - Hepatitis.B),
         Polio = log(1000 - Polio)) %>%
  select(-Status)
to_hist <- life_expect_t %>%
  select(-c(Life.Expectancy, GDP))
mapply(histLifeExpect,
       variable = to_hist,
       name = names(to_hist),
       width = c(0.2, 0.01, 5, 10, 7, 0.9, 2),
       SIMPLIFY = FALSE)
```

Hepatitis B, Polio, GDP, and Population appear to have no trend whatsoever, therefore there is no transformation we can apply to make them linear. BMI, Diptheria, and Schooling have very nice linear trends. Adult Mortality appears to have a roughly linear trend, but with a cone shape. We will attempt to transform it.

```{r, message=FALSE}
ggplot(data = life_expect_cu,
       mapping = aes(x = Adult.Mortality, y = Life.Expectancy)) +
  geom_point() +
  geom_smooth(se = FALSE) +
  theme_minimal() +
  theme(aspect.ratio = 1)
cor(life_expect_cu$Adult.Mortality, life_expect_cu$Life.Expectancy)

# Log transform
life_expect_cu_xt <- life_expect_cu %>%
  mutate(Adult.Mortality = log(Adult.Mortality))
ggplot(data = life_expect_cu_xt,
       mapping = aes(x = Adult.Mortality, y = Life.Expectancy)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  theme_minimal() +
  theme(aspect.ratio = 1)
cor(life_expect_cu_xt$Adult.Mortality, life_expect_cu_xt$Life.Expectancy)

# Reciprocal transform
life_expect_cu_xt <- life_expect_cu %>%
  mutate(Adult.Mortality = 1/(Adult.Mortality))
ggplot(data = life_expect_cu_xt,
       mapping = aes(x = Adult.Mortality, y = Life.Expectancy)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  theme_minimal() +
  theme(aspect.ratio = 1)
cor(life_expect_cu_xt$Adult.Mortality, life_expect_cu_xt$Life.Expectancy)

# Reciprocal squared transform
life_expect_cu_xt <- life_expect_cu %>%
  mutate(Adult.Mortality = 1/(Adult.Mortality)^2)
ggplot(data = life_expect_cu_xt,
       mapping = aes(x = Adult.Mortality, y = Life.Expectancy)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  theme_minimal() +
  theme(aspect.ratio = 1)
cor(life_expect_cu_xt$Adult.Mortality, life_expect_cu_xt$Life.Expectancy)
```
Based on the shape of the curve fit by `loess` we could add a squared and a cubic term in our model for Adult.Mortality, but we would risk over fitting. To check if that really improved our model we could fit a model with and without those terms and perform cross validation. We might also do the same thing for a reciprocal transformation. It seems however that the real trend in the original data is already linear, so for the purpose of this project, we will simply leave Adult.Mortality un-transformed.


##### Variable Selection

```{r, fig.align='center'}
# <... code here with different variable selection procedures...>
```
Variable            | Best Subset | Backward | Sequential Replacement | LASSO  | Elastic Net
--------------------| ----------- | -------- | ---------------------- | ------ | -----------
                    |             |          |                        |        |      


...Given the results from all of the variable selection procedures, shown in the table above, we choose to keep 

##### Initial Linear Model

```{r, fig.align='center'}
# <...code to fit linear model with selected variables and code to check ALL
# assumptions...>
```

After fitting the linear regression model and checking the assumptions, we notice several assumptions may not be met. Specifically...

##### Trying Several Linear Models

Since homoscedasticity was likely not met, we apply a Box-Cox transform to help us determine which transformation to use when transforming Y.

```{r, fig.align='center'}
# <...code for boxCox, new linear model, and assumption checking, etc...>
```

The Box-Cox transform suggested....and this helped with the homoscedasticity assumption. We also realized that we should transform the School variable to better satisfy the linearity assumption. Next, we saw that...

We decided to try including an interaction between ... and ... in our model since the results from our EDA suggested there might be a significant interaction between those two variables. 

```{r, fig.align='center'}
# <...code for interactions...>
```

We found that the interaction is significant after performing an ANOVA to compare the two models: one with the interaction, one without. We will now do one final check of the assumptions to make sure this model is appropriate to describe the data. 

##### Final Linear Model

```{r, fig.align='center'}
# <...code for linear model, assumption checking, etc...>
```

Our final model seems to meet all of the assumptions of linear regression. Specifically, the variance inflation factors are all under ten, and the residuals appear homoscedastic, as shown in the residuals versus fitted values plot. The assumption of... 

Our final fitted model is: 

$\log(\widehat{\text{AAMort}}_i) = \beta_0...$

##### Model Assessment

 

```{r, fig.align='center'}
# <... code here...>
# Include things like: slopes, hypothesis tests, confidence intervals, 
# prediction intervals, etc.
# If you have an interaction, code to compute the effect of one of the 
# interaction variables on the response, etc.
```

The confidence intervals for the variables are very informative. For example, we are 95% confident that... That is a fairly large range, and suggests increasing education opportunities in communities could significantly lower mortality. Another variable we found interesting was...

We also were able to make intervals for a new city like Provo. We found that...

< Include LOTS of interpretations here. Be especially cautious of your interpretations if you have interactions >

We are also interested in how well the model fits the data. To do this, we look at metrics such as $R^2$, the RMSE, and.... These metrics are important to check and understand because...

```{r, fig.align='center'}
# <...more code here...>
# Include things like: R2, RMSE, MAE, etc.
```

It turns out that the model fits the data pretty well. An $R^2$ of 74% is rather high, and indicates that...

### Summary and Conclusions

Understanding how environmental and socioeconomic characteristics contribute to the mortality rate can be critical to increasing overall human health and lifespan. We conducted an analysis to determine which of these types of variable significantly affect mortality, with a specific interest in air quality/pollution. After fitting a multiple linear regression model, we found that air quality, does, indeed, have a significant negative impact on mortality. We also found that the amount of education the population has decreases mortality. Additionally,...
